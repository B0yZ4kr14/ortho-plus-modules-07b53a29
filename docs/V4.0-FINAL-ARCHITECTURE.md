# Ortho+ V4.0 - Arquitetura Final

## üìã Vis√£o Geral

Sistema SaaS B2B Multitenant para Cl√≠nicas Odontol√≥gicas com arquitetura DDD (Domain-Driven Design) e sistema modular plug-and-play.

**Vers√£o:** 4.0.0  
**Data de Release:** 2025-01-15  
**Status:** ‚úÖ Produ√ß√£o

---

## üèóÔ∏è Arquitetura do Sistema

### Stack Tecnol√≥gica

```typescript
{
  "frontend": {
    "framework": "React 18.3.1",
    "bundler": "Vite",
    "language": "TypeScript 5.x",
    "styling": "Tailwind CSS 3.x",
    "ui": "Shadcn UI + Radix UI"
  },
  "backend": {
    "database": "Supabase (PostgreSQL)",
    "auth": "Supabase Auth",
    "storage": "Supabase Storage",
    "functions": "Supabase Edge Functions"
  },
  "patterns": {
    "architecture": "Domain-Driven Design (DDD)",
    "modules": "Plug-and-Play System",
    "state": "React Query + Context API",
    "di": "Custom Dependency Injection Container"
  }
}
```

---

## üì¶ Estrutura de M√≥dulos

### M√≥dulos Core (Sempre Ativos)

1. **PEP (Prontu√°rio Eletr√¥nico do Paciente)**
   - Gest√£o de pacientes
   - Hist√≥rico m√©dico
   - Anamnese digital

2. **AGENDA**
   - Agendamento de consultas
   - Gest√£o de hor√°rios
   - Automa√ß√£o via WhatsApp

3. **ODONTOGRAMA**
   - Odontograma 2D/3D
   - Planejamento de tratamentos

### M√≥dulos Financeiros

4. **FINANCEIRO**
   - Fluxo de caixa
   - Contas a pagar/receber
   - Concilia√ß√£o banc√°ria

5. **SPLIT_PAGAMENTO**
   - Split de pagamento
   - Otimiza√ß√£o tribut√°ria
   - Depende: FINANCEIRO

6. **INADIMPLENCIA**
   - Cobran√ßa automatizada
   - Relat√≥rios de inadimpl√™ncia
   - Depende: FINANCEIRO

### M√≥dulos de Crescimento

7. **CRM**
   - Gest√£o de leads
   - Funil de vendas
   - Pipeline de oportunidades

8. **MARKETING_AUTO**
   - Campanhas automatizadas
   - Recall p√≥s-consulta
   - E-mail marketing

9. **BI**
   - Business Intelligence
   - Dashboards customiz√°veis
   - Analytics avan√ßado

### M√≥dulos de Compliance

10. **LGPD**
    - Gest√£o de consentimentos
    - Auditoria de acesso
    - Relat√≥rios de conformidade

11. **ASSINATURA_ICP**
    - Assinatura digital qualificada
    - Certificado ICP-Brasil
    - Depende: PEP

12. **TISS**
    - Faturamento de conv√™nios
    - Padr√£o TISS
    - Depende: PEP

### M√≥dulos de Inova√ß√£o

13. **IA**
    - IA para diagn√≥stico radiogr√°fico
    - An√°lise preditiva
    - Depende: PEP, FLUXO_DIGITAL

14. **FLUXO_DIGITAL**
    - Integra√ß√£o com scanners intraorais
    - Integra√ß√£o com laborat√≥rios
    - Depende: PEP

15. **TELEODONTO**
    - Videochamadas integradas
    - Prontu√°rio digital remoto

---

## üîê Seguran√ßa e Compliance

### Row Level Security (RLS)

Todas as tabelas implementam RLS com pol√≠ticas baseadas em:
- `clinic_id` (tenant isolation)
- `auth.uid()` (user authentication)
- `app_role` (role-based access)

### Auditoria (LGPD)

```sql
-- Todas as a√ß√µes cr√≠ticas s√£o registradas
INSERT INTO audit_logs (
  user_id,
  clinic_id,
  action,
  target_module_id,
  details
) VALUES (...);
```

### Fun√ß√µes Security Definer

```sql
-- Evita recurs√£o infinita em RLS
CREATE OR REPLACE FUNCTION get_user_clinic_id()
RETURNS uuid
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT clinic_id FROM profiles WHERE id = auth.uid()
$$;
```

---

## üéØ Sistema de Depend√™ncias

### Grafo de Depend√™ncias

```mermaid
graph TD
    PEP[PEP - Core]
    FINANCEIRO[FINANCEIRO]
    SPLIT[SPLIT_PAGAMENTO]
    INADIMPLENCIA[INADIMPLENCIA]
    FLUXO_DIGITAL[FLUXO_DIGITAL]
    IA[IA]
    ASSINATURA[ASSINATURA_ICP]
    TISS[TISS]

    SPLIT --> FINANCEIRO
    INADIMPLENCIA --> FINANCEIRO
    ASSINATURA --> PEP
    TISS --> PEP
    FLUXO_DIGITAL --> PEP
    IA --> PEP
    IA --> FLUXO_DIGITAL
```

### Regras de Ativa√ß√£o

1. **M√≥dulo pode ser ATIVADO se:**
   - Todos os m√≥dulos requeridos (depend√™ncias) est√£o ativos
   - `can_activate = true`

2. **M√≥dulo pode ser DESATIVADO se:**
   - Nenhum m√≥dulo ativo depende dele
   - `can_deactivate = true`

---

## üìä Sidebar Profissional (V4.0)

### Nova Estrutura de Categorias

```typescript
const categories = [
  'In√≠cio',                        // Dashboard
  'Atendimento Cl√≠nico',          // Core Clinical (sempre expandido)
  'Financeiro',                    // Revenue Operations
  'Opera√ß√µes da Cl√≠nica',         // Clinic Operations
  'Vendas & Marketing',           // Growth & Sales
  'Compliance & Regulamenta√ß√£o',  // Compliance & Security
  'Tecnologia Avan√ßada',          // Advanced Technology
  'Suporte'                        // Help Center
];
```

### √çcones Modernos

- **Sparkles** ‚Üí IA Diagn√≥stico
- **BriefcaseBusiness** ‚Üí CRM
- **Target** ‚Üí Funil de Vendas
- **Megaphone** ‚Üí Campanhas
- **Lock** ‚Üí LGPD
- **HeartPulse** ‚Üí Tratamentos
- **ClipboardPlus** ‚Üí Prontu√°rio

---

## ‚ö° Performance

### Otimiza√ß√µes Implementadas

1. **React.memo** em componentes cr√≠ticos
2. **useMemo** para c√°lculos pesados
3. **useCallback** para fun√ß√µes memoizadas
4. **React Query** para cache inteligente
5. **Lazy Loading** de rotas
6. **Code Splitting** por m√≥dulo

### M√©tricas de Performance

```javascript
{
  "FCP": "< 1.5s",    // First Contentful Paint
  "LCP": "< 2.5s",    // Largest Contentful Paint
  "TBT": "< 200ms",   // Total Blocking Time
  "CLS": "< 0.1",     // Cumulative Layout Shift
  "Bundle": "< 500KB" // Initial Bundle Size
}
```

---

## üß™ Qualidade de C√≥digo

### Checklist de Qualidade

- ‚úÖ TypeScript Strict Mode
- ‚úÖ ESLint + Prettier
- ‚úÖ DDD Architecture
- ‚úÖ SOLID Principles
- ‚úÖ Clean Code
- ‚úÖ Security Definer Functions
- ‚úÖ RLS em todas as tabelas
- ‚úÖ Auditoria LGPD
- ‚úÖ Documenta√ß√£o completa

### Valida√ß√£o Automatizada

```bash
# Executar valida√ß√£o de qualidade
npm run validate:quality
```

---

## üìà Roadmap V5.0

### Features Planejadas

1. **Busca Global (‚åòK)**
   - Command Palette
   - Busca unificada

2. **P√°gina Unificada de Estoque**
   - Tabs para navega√ß√£o
   - Dashboard integrado

3. **Testes E2E**
   - Playwright
   - Cobertura > 80%

4. **PWA**
   - Offline-first
   - Service Workers

5. **Mobile Apps**
   - React Native
   - iOS + Android

---

## ü§ù Contribuindo

### Workflow de Desenvolvimento

1. **Branch Strategy**: Git Flow
2. **Commits**: Conventional Commits
3. **PRs**: Code Review obrigat√≥rio
4. **CI/CD**: GitHub Actions

### Padr√µes de C√≥digo

```typescript
// ‚úÖ BOM - DDD Pattern
class CreatePatientUseCase {
  constructor(private patientRepo: IPatientRepository) {}
  
  async execute(input: CreatePatientInput): Promise<Patient> {
    const patient = Patient.create(input);
    return this.patientRepo.save(patient);
  }
}

// ‚ùå RUIM - Acoplamento direto
const savePatient = async (data) => {
  const { data: patient } = await supabase
    .from('patients')
    .insert(data);
  return patient;
};
```

---

## üìû Suporte

- **Documenta√ß√£o:** `/docs`
- **Wiki:** `/docs/wiki`
- **ADRs:** `/docs/architecture`
- **Changelog:** `CHANGELOG-V4.0.md`

---

**Ortho+ V4.0** - Sistema Odontol√≥gico Enterprise ü¶∑‚ú®
